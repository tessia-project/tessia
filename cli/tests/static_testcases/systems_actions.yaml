description: Exercise creation and deletion of cpc/lpar/kvm guest
base_user: admin
tasks_order:
  - base_add
  - lpar_add
  - kvm_add
  - kvm_del
  - lpar_del
tasks:
  base_add:
    # lab admin to create the lab resources
    - - perm project-add --name='GEO_1 labadmins' --desc='GEO_1 lab admins'
      - Item added successfully.
    - - perm user-add --login=lab_admin@example.com --name='ADMIN_LAB' --title='Title of lab admin'
      - User added successfully.
    - - perm role-grant --login=lab_admin@example.com --name='ADMIN_LAB' --project='GEO_1 labadmins'
      - User role added successfully.
    # create the target project
    - - perm project-add --name='GEO_1 developers' --desc='Developer team'
      - Item added successfully.
    # make sure lab admin also has permissions on this project
    - - perm role-grant --login=lab_admin@example.com --name='ADMIN_LAB' --project='GEO_1 developers'
      - User role added successfully.
    # create target user
    - - perm user-add --login=dev1@example.com --name='Developer 1' --title='Mr. Developer 1'
      - User added successfully.
    - - perm role-grant --login=dev1@example.com --name='USER' --project='GEO_1 developers'
      - User role added successfully.
    # switch to lab admin user
    - - - conf key-gen
        - lab_admin@example.com
        - password
      - Key successfully created and added to client configuration.
    # create the net resources
    - - net zone-add --name=GEO_1-NE --project='GEO_1 labadmins' --desc='GEO-NE, VLAN 1822'
      - Item added successfully.
    - - net subnet-add --zone=GEO_1-NE --name='GEO_1-NE-1822' --address=192.168.160.0/22  --gw=192.168.160.1 --dns1=192.168.200.241 --vlan=1822 --project='GEO_1 labadmins' --desc='Shared zone vlan 1822'
      - Item added successfully.
    # create the storage resources
    - - storage server-add --name=DS8K16 --model=DS8000 --type=DASD-FCP --project='GEO_1 labadmins'
      - Item added successfully.
    # repositories
    - - repo add --name='RHEL7.2-GA' --url='http://example.com/redhat/s390x/RHEL7.2/DVD' --kernel='/images/kernel.img' --initrd='/images/initrd.img' --os=rhel7.2
      - Item added successfully.
    - - repo add --name='SLES12.1-GA' --url='http://example.com/suse/s390x/SLES12.1/DVD' --kernel='/boot/s390x/linux' --initrd='/boot/s390x/initrd' --os=sles12.1
      - Item added successfully.
  lpar_add:
    # create the net resources
    - - net ip-add --subnet='GEO_1-NE-1822' --ip=192.168.161.222  --project='GEO_1 developers' --desc='For use by lpar 52'
      - Item added successfully.
    # create the storage resources
    - - storage vol-add --server=DS8K16 --type=DASD --id=3951 --size=7gb --project='GEO_1 labadmins' --desc='live-image disk for cpc cpc3'
      - Item added successfully.
    - - storage vol-add --server=DS8K16 --type=DASD --id=3956 --size=7gb --owner=dev1@example.com --project='GEO_1 developers' --desc='belongs to zVM guest/LPAR'
      - Item added successfully.
    - - storage part-init --server=DS8K16 --id=3956 --label=dasd
      - Partition table successfully initialized.
    - - storage part-add --server=DS8K16 --id=3956 --fs=ext4 --size=7gb --mp=/
      - Partition successfully added.
    - - storage vol-add --server=DS8K16 --type=DASD --id=3957 --size=7gb --owner=dev1@example.com --project='GEO_1 developers' --desc='belongs to zVM guest/LPAR'
      - Item added successfully.
    - - storage part-init --server=DS8K16 --id=3957 --label=dasd
      - Partition table successfully initialized.
    - - storage part-add --server=DS8K16 --id=3957 --fs=swap --size=7gb
      - Partition successfully added.
    - - storage vol-add --server=DS8K16 --type=FCP --id=1022400100000000 --size=10gb --owner=dev1@example.com --project='GEO_1 developers' --desc='For tessia SVT' --path='1800,100207630503c1ae' --path='1800,100207630508c1ae' --path='1800,100207630510c1ae' --path='1800,100207630513c1ae' --path='1880,100207630503c1ae' --path='1880,100207630508c1ae' --path='1880,100207630510c1ae' --path='1880,100207630513c1ae' --mpath=true --wwid=11002076305aac1a0000000000002201
      - Item added successfully.
    - - storage part-init --server=DS8K16 --id=1022400100000000 --label=msdos
      - Partition table successfully initialized.
    - - storage part-add --server=DS8K16 --id=1022400100000000 --fs=ext4 --size=9gb --mp=/
      - Partition successfully added.
    - - storage part-add --server=DS8K16 --id=1022400100000000 --fs=swap --size=1gb
      - Partition successfully added.
    # create the system resources
    - - system add --name=cpc3 --type=cpc --hostname=hmcserver.example.com --model=zec12_h43 --project='GEO_1 labadmins' --desc='2 Books and 43 processors'
      - Item added successfully.
    - - system add --name=cpc3lp52 --hyp=cpc3 --type=LPAR --hostname=cpc3lp52.example.com --desc='SVT Developer 1' --owner=dev1@example.com --project='GEO_1 developers'
      - Item added successfully.
    - - system iface-add --system=cpc3lp52 --name='default osa' --type=OSA --devname=enccw0.0.f500 --mac=02:57:52:00:76:00 --layer2=true --ccwgroup=f500,0.0.f501,0.0.f502 --desc='gateway interface' --subnet='GEO_1-NE-1822' --ip=192.168.161.222
      - Item added successfully.
    # create activation profiles
    - - system prof-add --system=cpc3 --name='default cpc3' --cpu=43 --memory=1136gb --login='DEVEL1:somepwd'
      - Item added successfully.
    - - system vol-attach --system=cpc3 --profile='default cpc3' --server=DS8K16 --vol=3951
      - Volume attached successfully.
    - - system prof-add --system=cpc3lp52 --name='DASD root1' --cpu=4 --memory=2048mb --login='root:mypasswd' --hyp='default cpc3'
      - Item added successfully.
    - - system iface-attach --system=cpc3lp52 --profile='DASD root1' --iface='default osa'
      - Network interface attached successfully.
    - - system vol-attach --system=cpc3lp52 --profile='DASD root1' --server=DS8K16 --vol=3956
      - Volume attached successfully.
    - - system vol-attach --system=cpc3lp52 --profile='DASD root1' --server=DS8K16 --vol=3957
      - Volume attached successfully.
    - - system prof-add --system=cpc3lp52 --name='FCP root1' --cpu=4 --memory=2048mb --login='root:mypasswd' --hyp='default cpc3'
      - Item added successfully.
    - - system iface-attach --system=cpc3lp52 --profile='FCP root1' --iface='default osa'
      - Network interface attached successfully.
    - - system vol-attach --system=cpc3lp52 --profile='FCP root1' --server=DS8K16 --vol=1022400100000000
      - Volume attached successfully.
  kvm_add:
    # network
    - - net ip-add --subnet='GEO_1-NE-1822' --ip=192.168.160.55  --project='GEO_1 developers' --desc='For use by guest55'
      - Item added successfully.
    # storage
    - - storage vol-add --server=DS8K16 --type=FCP --id=1022400200000000 --size=10gb --owner=dev1@example.com --project='GEO_1 developers' --desc='For tessia SVT' --path='1800,100207630503c1ae' --path='1800,100207630508c1ae' --path='1800,100207630510c1ae' --path='1800,100207630513c1ae' --path='1880,100207630503c1ae' --path='1880,100207630508c1ae' --path='1880,100207630510c1ae' --path='1880,100207630513c1ae' --mpath=true --wwid=11002076305aac1a0000000000002202
      - Item added successfully.
    - - storage part-init --server=DS8K16 --id=1022400200000000 --label=msdos
      - Partition table successfully initialized.
    - - storage part-add --server=DS8K16 --id=1022400200000000 --fs=ext4 --size=9gb --mp=/
      - Partition successfully added.
    - - storage part-add --server=DS8K16 --id=1022400200000000 --fs=swap --size=1gb
      - Partition successfully added.
    - - storage vol-add --server=DS8K16 --type=FCP --id=1022400300000000 --size=10gb --owner=dev1@example.com --project='GEO_1 developers' --desc='For tessia SVT' --path='1800,100207630503c1ae' --path='1800,100207630508c1ae' --path='1800,100207630510c1ae' --path='1800,100207630513c1ae' --path='1880,100207630503c1ae' --path='1880,100207630508c1ae' --path='1880,100207630510c1ae' --path='1880,100207630513c1ae' --mpath=true --wwid=11002076305aac1a0000000000002203
      - Item added successfully.
    - - storage part-init --server=DS8K16 --id=1022400300000000 --label=msdos
      - Partition table successfully initialized.
    - - storage part-add --server=DS8K16 --id=1022400300000000 --fs=ext4 --size=10gb --mp=/home
      - Partition successfully added.
    # system
    - - system add --name=guest55 --hyp=cpc3lp52 --type=KVM --hostname=guest55.example.com --desc='SVT Developer 1' --owner=dev1@example.com --project='GEO_1 developers'
      - Item added successfully.
    - - system iface-add --system=guest55 --name='default macvtap' --type=macvtap --devname=en0 --mac=00:11:22:33:44:55 --desc='gateway interface' --subnet='GEO_1-NE-1822' --ip=192.168.160.55 --hostiface=enccw0.0.f500
      - Item added successfully.
    # create activation profiles
    - - system prof-add --system=guest55 --name='KVM root1' --cpu=2 --memory=1024mb --login='root:mypasswd' --hyp='FCP root1'
      - Item added successfully.
    - - system iface-attach --system=guest55 --profile='KVM root1' --iface='default macvtap'
      - Network interface attached successfully.
    - - system vol-attach --system=guest55 --profile='KVM root1' --server=DS8K16 --vol=1022400200000000
      - Volume attached successfully.
    - - system vol-attach --system=guest55 --profile='KVM root1' --server=DS8K16 --vol=1022400300000000
      - Volume attached successfully.
  kvm_del:
    # switch to developer user to test whether they have the rights to perform the following actions
    - - - conf key-gen
        - dev1@example.com
        - password
      - Key successfully created and added to client configuration.
    - - system iface-detach --system=guest55 --profile='KVM root1' --iface='default macvtap'
      - Network interface detached successfully.
    - - system vol-detach --system=guest55 --profile='KVM root1' --server=DS8K16 --vol=1022400200000000
      - Volume detached successfully.
    - - system vol-detach --system=guest55 --profile='KVM root1' --server=DS8K16 --vol=1022400300000000
      - Volume detached successfully.
    - - system prof-del --system=guest55 --name='KVM root1'
      - Item successfully deleted.
    - - system del --name=guest55
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=1022400200000000
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=1022400300000000
      - Item successfully deleted.
  lpar_del:
    - - system iface-detach --system=cpc3lp52 --profile='DASD root1' --iface='default osa'
      - Network interface detached successfully.
    - - system iface-detach --system=cpc3lp52 --profile='FCP root1' --iface='default osa'
      - Network interface detached successfully.
    - - system vol-detach --system=cpc3lp52 --profile='DASD root1' --server=DS8K16 --vol=3956
      - Volume detached successfully.
    - - system vol-detach --system=cpc3lp52 --profile='DASD root1' --server=DS8K16 --vol=3957
      - Volume detached successfully.
    - - system vol-detach --system=cpc3lp52 --profile='FCP root1' --server=DS8K16 --vol=1022400100000000
      - Volume detached successfully.
        # first remove the non default profile to avoid error
    - - system prof-del --system=cpc3lp52 --name='FCP root1'
      - Item successfully deleted.
    - - system prof-del --system=cpc3lp52 --name='DASD root1'
      - Item successfully deleted.
    - - system del --name=cpc3lp52
      - Item successfully deleted.
    # resources owned by lab admin user
    - - - conf key-gen
        - lab_admin@example.com
        - password
      - Key successfully created and added to client configuration.
    - - system vol-detach --system=cpc3 --profile='default cpc3' --server=DS8K16 --vol=3951
      - Volume detached successfully.
    - - system prof-del --system=cpc3 --name='default cpc3'
      - Item successfully deleted.
    - - system del --name=cpc3
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=3951
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=3956
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=3957
      - Item successfully deleted.
    - - storage vol-del --server=DS8K16 --id=1022400100000000
      - Item successfully deleted.
    - - storage server-del --name=DS8K16
      - Item successfully deleted.
    - - net subnet-del --zone=GEO_1-NE --name=GEO_1-NE-1822
      - Item successfully deleted.
    - - net zone-del --name=GEO_1-NE
      - Item successfully deleted.
    - - repo del --name='RHEL7.2-GA'
      - Item successfully deleted.
    - - repo del --name='SLES12.1-GA'
      - Item successfully deleted.
